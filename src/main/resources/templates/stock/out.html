<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout/default">
<head>
<meta charset="utf-8" />
<title>领取</title>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" th:href="@{/styles/iview.css}" />
<style type="text/css">
.layout-breadcrumb{
    padding: 0px;margin-bottom:10px;
}
</style>
</head>
<body style="background-color: #eee;">
<div layout:fragment="content" style="width:1280px;min-height: 600px;margin:15px auto;background-color: #ffffff;">
    <template id="order_page" style="">
        <div>
            <Modal v-model="visible" title="请填写领取信息" ok-text = "确定" @on-ok="add('orderForm')" width="900" :mask-closable="false" >
                <i-form ref="orderForm" :model="orderForm" :label-width="80" >
                    <Row>
                        <i-col span="8" >
                            <Form-item label="名称：">
                                {{stock.stockName}}
                            </Form-item>
                        </i-col>
                        <i-col span="8" >
                            <Form-item label="分类：">
                                {{stock.categoryId}}
                            </Form-item>
                        </i-col>
                        <i-col span="8" >
                            <Form-item label="类型：">
                                {{getStockType(stock.type)}}
                            </Form-item>
                        </i-col>
                    </Row>
                    <Row>
                        <i-col span="8" >
                            <Form-item label="上次单价：">
                                {{stock.price}}
                            </Form-item>
                        </i-col>
                        <i-col span="8" >
                            <Form-item label="单位：">
                                {{stock.unit}}
                            </Form-item>
                        </i-col>
                        <i-col span="8" >
                            <Form-item label="品牌：">
                                {{stock.brand}}
                            </Form-item>
                        </i-col>
                    </Row>
                    <Row>
                        <i-col span="24" >
                            <div v-if="orderForm.usableOrders.length > 0" style="margin-bottom:20px;font-size:14px;font-weight: bold;">
                                可领取清单如下：
                            </div>
                            <div v-else style="margin-bottom:20px;font-size:16px;font-weight: bold;text-align: center;color: #ed3f14;">
                                <div v-if="visible">
                                暂无可用库存！请先补货！
                                </div>
                            </div>
                        </i-col>
                    </Row>
                    <Form-item
                            v-for="(item, index) in orderForm.usableOrders"
                            :key="index"
                            :label-width="10"
                            :prop="'usableOrders.' + index + '.outCount'"
                            :rules="{ type: 'number' , max: item.usable ,message: '领取数量不能大于剩余数量', trigger: 'blur' }">
                        <Row>
                            <i-col span="6" style="text-align:left;">
                                入库日期：{{new Date(item.operDate).Format("yyyy-MM-dd")}}
                            </i-col>
                            <i-col span="4">
                                单价： ￥ {{item.price}}
                            </i-col>
                            <i-col span="4">
                                剩余数量：{{item.usable}}  {{stock.unit}}
                            </i-col>
                            <i-col span="4" style="text-align:center;">
                                本次领取数量：
                            </i-col>
                            <i-col span="6">
                                <Input-number v-model="item.outCount" style="width:120px" ></Input-number>
                            </i-col>
                        </Row>
                    </Form-item>

                </i-form>
                <div slot="footer" style="text-align:center">
                    <!--<i-button type="primary" @click="add('orderForm')" size="large" style="width:120px;">确定</i-button>-->
                    <i-button type="primary" size="large" @click="saveOrder('orderForm')" :loading="loading" icon="android-upload" style="">
                        <span v-if="!loading">提交审核</span>
                        <span v-else>提交中,请稍后...</span>
                    </i-button>
                </div>
            </Modal>

            <Row>
                <i-col span="24" style="padding-left:400px;">
                    <i-select
                            v-model="selectStockId"
                            filterable
                            remote
                            placeholder="请输入物品名称或缩写字母"
                            size="large"
                            :remote-method="remoteMethod"
                            :loading="loading"
                            @on-change="submitForm2"
                            style="width:400px"
                    >
                        <i-option v-for="item in stockList" :value="item.abbr+'-'+item.stockId" :key="item.stockName">{{item.stockName}}</i-option>
                    </i-select>
                    <i-button type="primary" @click="submitForm" style="margin-left: 20px;">填领取单</i-button>

                </i-col>
            </Row>
            <i-table border :columns="columns" :data="orderList" no-data-text="尚未录入单据" stripe="true" style="margin-top: 50px;"></i-table>
            <br>

        </div>
    </template>
    <div id="layout-breadcrumb" class="layout-breadcrumb">
        <div style="padding:10px;background-color: #fff;">
            <Breadcrumb>
                <Breadcrumb-item href="#">库存</Breadcrumb-item>
                <Breadcrumb-item href="#">单据</Breadcrumb-item>
                <Breadcrumb-item>领取</Breadcrumb-item>
            </Breadcrumb>
        </div>
        <div style="height:15px;background-color: #eee;"></div>
    </div>
    <div id="app" style="padding: 10px;">
        <router-view></router-view>
    </div>
    <script th:src="@{/js/vue.min.js}"></script>
    <script th:src="@{/js/iview.min.js}"></script>
    <script th:src="@{/js/vue-router.js}"></script>
    <script th:src="@{/js/vue-resource.min.js}"></script>
    <script th:src="@{/js/jquery-3.2.1.min.js}"></script>
    <script th:src="@{/js/common.js}"></script>
    <script th:src="@{/js/const.js}"></script>
    <script th:inline="javascript">
        window.head.active="stock_out";
        var order_page = {
            template: '#order_page',
            data: function() {
                return {
                    columns: [
                        {
                            title: '入库单号',
                            key: 'relationId',
                            render: function(h, params) {
                                var str="";
                                console.log("row.relationId="+params.row.relationId);
                                if(params.row.relationId.length>20){
                                    str = params.row.relationId.substr(10,6);
                                }
                                return  str;
                            }
                        },
                        {
                            title: '物品名称',
                            key: 'stockName'
                        },
                        {
                            title: '入库日期',
                            key: 'inDate'
                        },
                        {
                            title: '采购单价',
                            key: 'price'
                        },
                        {
                            title: '领取数量',
                            key: 'count'
                        },
                        {
                            title: '单位',
                            key: 'unit'
                        },
                        {
                            title: '合计',
                            key: 'total'
                        },
                        {
                            title: '领取日期',
                            key: 'operDate'
                        },
                        {
                            title: '领取部门',
                            key: 'departId'
                        }
                    ],
                    orderRule: {
                        price: [
                            { type: 'number' ,required: true, message: '请填写采购单价', trigger: 'blur' }
                        ],
                        count: [
                            { type: 'number' ,required: true, message: '请填写采购数量', trigger: 'blur' },
                            { type: 'number' , min:0 ,message: '数量必须大于零', trigger: 'blur' }
                        ]
                    },
                    visible: false,
                    loading: false,
                    selectStockId:"",
                    stockList:[],
                    supplierList:[],
                    orderList:[],
                    list:[

                    ],
                    orderForm:{
                        departId:"1",
                        buyDate:new Date(),
                        usableOrders:[]
                    },
                    stock:{
                        stockId:"",
                        stockName:"",
                        abbr:"",
                        brand:"",
                        unit:"",
                        price:"",
                        count:"",
                        categoryId:"",
                        supplierId:"",
                        type:""
                    },
                    loading : false
                }
            },
            created : function  () {
                this.loadData()
            },
            methods: {
                loadData: function () {
                    this.stockList.push({})
                    this.$http.get('/stock/api/list?type=2',{}).then(function(response){
                        this.list = response.data;
                    }, function(response){

                    }).bind(this);
                    this.$http.get('/stock/api/supplierList',{}).then(function(response){
                        this.supplierList = response.data;
                    }, function(response){

                    }).bind(this);
                },
                saveOrder: function (name) {
                    if(this.orderForm.usableOrders.length==0){
                        this.$Message.error('暂无可用库存！请先补货！');
                        return;
                    }
                    var that = this;
                    this.$refs[name].validate(function(valid){
                        if(valid){
                            var postList = [];
                            that.orderForm.usableOrders.forEach(function(temp){
                                if(temp.outCount==0){
                                    return;
                                }
                                var order = {};
                                order.orderId = temp.orderId
                                order.total = parseFloat(temp.price * temp.outCount).toFixed(2);
                                order.inDate = new Date(temp.operDate).Format("yyyy-MM-dd");
                                order.relationId = temp.orderId;
                                order.type = Global.stock.order.out;
                                order.stockId = temp.stockId;
                                order.stockName = that.stock.stockName;
                                order.unit = that.stock.unit;
                                order.price = temp.price;
                                order.count = temp.outCount;
                                order.departId = that.orderForm.departId;
                                if(that.orderForm.buyDate){
                                    order.operDate = that.orderForm.buyDate.Format("yyyy-MM-dd");
                                }
                                postList.push(order);
                            })
                            if(postList.length==0){
                                that.$Message.error('请填写单据！');
                            }else{
                                that.loading = true;
                                that.$http.post('/stock/api/order/saveOut',postList,{
                                }).then(function(response){
                                    that.loading = false;
                                    if(response.data.success==true){
                                        that.$Modal.success({
                                            content: response.data.msg
                                        });
                                        that.visible = false;
                                        that.selectStockId = "";
                                        that.stockList = [];
                                        that.stock = {};
                                        that.resetForm();
                                        postList.forEach(function(o){
                                            that.orderList.push(o);
                                        })
                                    }else{
                                        that.$Modal.error({
                                            content: response.data.msg
                                        });
                                    }
                                }, function(response){
                                    that.loading = false;
                                })
                            }
                        }
                    });
                },
                submitForm: function () {
                    if(this.selectStockId.split("-")[1]){
                        this.resetForm();
                        this.$http.get('/stock/api/infoAndUsableInOrder/'+this.selectStockId.split("-")[1],{}).then(function(response){
                            this.stock = response.data.stock;
                            this.orderForm.usableOrders = response.data.orders;
                            this.orderForm.usableOrders.forEach(function(temp){
                                temp.outCount = 0;
                            })
                            this.visible = true;
                        }, function(response){

                        }).bind(this);
                    }else{
                        this.$Message.error('请先选择物品');
                    }
                },
                submitForm2: function (item) {
                    if(item.split("-")[1]){
                        this.resetForm();
                        this.$http.get('/stock/api/infoAndUsableInOrder/'+item.split("-")[1],{}).then(function(response){
                            this.stock = response.data.stock;
                            this.orderForm.usableOrders = response.data.orders;
                            this.orderForm.usableOrders.forEach(function(temp){
                                temp.outCount = 0;
                            })
                            this.visible = true;
                        }, function(response){

                        }).bind(this);
                    }else{

                    }
                },
                resetForm: function () {
                    this.stock={}
                    this.orderForm.usableOrders=[]
                },
                remoteMethod: function (query) {
                    if (query !== '') {
                        this.stockList = this.list.filter(function(elem, pos) {
                            return elem.abbr.toLowerCase().indexOf(query.toLowerCase()) == 0||elem.stockName.toLowerCase().indexOf(query.toLowerCase()) > -1;
                        })
                    }else{
                        this.stockList = [];
                    }
                },
                remove: function (index) {
                    this.orderList.splice(index, 1);
                },
                resetPage: function () {
                    this.resetForm();
                    this.selectStockId=""
                    this.stockList=[]
                    this.orderList=[]
                },
            }
        }

        var routes = [
            {
                path: '/',
                name: 'order_page',
                component: order_page
            }
        ]

        var router = new VueRouter({
            routes: routes
        });

        router.beforeEach( function(to, from, next) {
            next()
        })

        var app = new Vue({
            el:'#app',
            router:router
        })

        var breadcrumb = new Vue({
            el:'#layout-breadcrumb'
        })

    </script>
</div>
</body>
</html>