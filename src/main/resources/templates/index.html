<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorator="layout/default">
<head>
<meta charset="utf-8" />
<title>登录</title>
<meta http-equiv="X-UA-Compatible" content="IE=Edge" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="stylesheet" th:href="@{/styles/iview.css}" />
<style type="text/css">
.layout-breadcrumb{
    padding: 0px;margin-bottom:10px;
}
</style>
</head>
<body style="background-color: #eee;">
<div layout:fragment="content" style="width:1280px;min-height: 600px;margin:15px auto;background-color: #ffffff;">
<template id="test" style="">
    <div>
        <p>hello world!</p>
        <Modal v-model="visible" title="Welcome">欢迎使用 iView index</Modal>
        <p><i-button type="primary" @click="show">Click me!</i-button></p>
        <i-select
            v-model="stock"
            filterable
            remote
            placeholder="请选择物品"
            size="large"
            :remote-method="remoteMethod"
            :loading="loading"
            style="width:400px"
        >
            <i-option v-for="option in stockList" :value="option.value" :key="option.value">{{option.label}}</i-option>
        </i-select>

        <i-button type="primary" @click="submitForm">提交</i-button>

    </div>
</template>
<div id="layout-breadcrumb" class="layout-breadcrumb">
    <div style="padding:10px;background-color: #fff;">
        <Breadcrumb>
            <Breadcrumb-item href="#">首页</Breadcrumb-item>
            <Breadcrumb-item href="#">应用中心</Breadcrumb-item>
            <Breadcrumb-item>某应用</Breadcrumb-item>
        </Breadcrumb>
    </div>
    <div style="height:15px;background-color: #eee;"></div>
</div>
<div id="app" style="padding: 10px;">
    <h1>Hello Start!</h1>
    <p>
        <!-- 使用 router-link 组件来导航. -->
        <!-- 通过传入 `to` 属性指定链接. -->
        <!-- <router-link> 默认会被渲染成一个 `<a>` 标签 -->
        <router-link to="/" tag="button">Go to Foo1</router-link>
        <router-link to="/bar?id=hello&name=world" tag="button">Go to Bar1</router-link>
        <router-link :to="{ name: 'getFoo', params: { id: 123,name:456 }}" tag="button">Go to Foo2</router-link>
        <router-link to="/change?id=hello&name=vuejs" tag="button">Go to Bar2</router-link>
        <router-link to="/barAlias?id=hello&name=deamon" tag="button">Go to BarAlias</router-link>
        <router-link to="/test" tag="button">Go to test</router-link>
    </p>
    <!-- 路由出口 -->
    <!-- 路由匹配到的组件将渲染在这里 -->
    <router-view></router-view>
    <p>
    <h1>Hello End!</h1>
    </p>
</div>
<script th:src="@{/js/vue.min.js}"></script>
<script th:src="@{/js/iview.min.js}"></script>
<script th:src="@{/js/vue-router.js}"></script>
<script th:src="@{/js/vue-resource.min.js}"></script>
<script th:src="@{/js/jquery-3.2.1.min.js}"></script>
<script th:inline="javascript">
    //    Vue.http.options.emulateJSON = true;  //跨域调用时才有效
    var login = {};
    login.test = {
        template: '#test',
        data: function() {
            return {
                visible: false,
                loading: false,
                stock:"",
                stockList:[],
                list:[
                    {
                        value: 'beijing',
                        label: '北京市'
                    },
                    {
                        value: 'shanghai',
                        label: '上海市'
                    }
                ]
            }
        },
        created : function  () {
            // 组件创建完后获取数据，
            // 此时 data 已经被 observed 了
            this.loadData()
        },
        methods: {
            show: function () {
                this.visible = true;
            },
            loadData: function () {
                var item = {
                    value: 'tianjin',
                    label: '天津市'
                }
                this.stockList.push(item)
                this.list.push(item)
                this.$http.get('/test/data',{}).then(function(response){
                    this.list = response.data.data;
                }, function(response){

                }).bind(this);
            },
            handleSubmit: function (name) {
                var that = this;
                this.$refs[name].validate(function(valid){
                    if (valid) {
                        that.$Message.success('提交成功!');
                    } else {
                        that.$Message.error('表单验证失败!');
                    }
                });
            },
            submitForm: function () {
                alert(this.stock)
            },
            remoteMethod: function (query) {
//                alert(query)
//                this.stockList = this.list;
                if (query !== '') {
                    this.loading = true;
                    this.stockList = [];
                    this.loading = false;
//                    for (var index in this.list) {
//                        var value = this.list[index].value.toLowerCase();
////                        alert("item = "+this.list[item].value);
//                        if(value.indexOf(query.toLowerCase()) == 0){
//                            this.stockList.push(this.list[index])
//                        }else if(this.list[index].label.indexOf(query.toLowerCase()) > -1){
//                            this.stockList.push(this.list[index])
//                        }
//                    }
                    this.stockList = this.list.filter(function(elem, pos) {
                        return elem.value.toLowerCase().indexOf(query.toLowerCase()) == 0||elem.label.toLowerCase().indexOf(query.toLowerCase()) > -1;
                    });
                }else{
                    this.stockList = [];
                    this.stock = '';
                }
            }
        }
    }
    // 1. 定义（路由）组件。
    login.list = {
        template: '<div>app.list</div>',
        beforeRouteEnter : function  (to, from, next) {
            //alert(' beforeRouteEnter   Foo,to='+to+',from='+from+',next='+next)
            next(function(vm){
                vm.loadData();
            })
        },
        beforeRouteLeave : function  (to, from, next) {
            //alert(' beforeRouteLeave  Foo,to='+to+',from='+from+',next='+next)
            this.deleteData()
            next()
        },
        created : function  () {
            // 组件创建完后获取数据，
            // 此时 data 已经被 observed 了
            this.fetchData()
        },
        watch: {
            // 如果路由有变化，会再次执行该方法 路由变化是指url变化了
            '$route':'fetchData'
        },
        methods: {
            loadData: function () {
//                alert('loadData1 , route = '+this.$route.path)
            },
            fetchData: function () {
                //alert('fetchData')
                console.log( ' fetchData ' );
            },
            deleteData: function () {
                alert('deleteData , route = '+this.$route)
            }
        }
    }
    var Bar = {
        template: '<div>bar .</div>',
        beforeRouteEnter : function  (to, from, next) {
            //alert('Foo,to='+to+',from='+from+',next='+next)
            next(function(vm){
                vm.loadData();
            })

        },
        beforeRouteLeave : function  (to, from, next) {
            //alert('Foo,to='+to+',from='+from+',next='+next)
            this.deleteData()
            next()
        },
        created : function  () {
            // 组件创建完后获取数据，
            // 此时 data 已经被 observed 了
            this.fetchData()
        },
        watch: {
            '$route':'fetchData'
        },
        methods: {
            loadData: function () {
                alert('loadData2 , route = '+this.$route.path)
            },
            fetchData: function () {
                //alert('fetchData')
                console.log( ' fetchData ' );
            },
            deleteData: function () {
                alert('deleteData , route = '+this.$route)
            }
        }
    }

    var routes = [
        {
            path: '/test',
            name: 'getFoo',
            component: login.list,
            beforeEnter: function  (to, from, next) {
                //alert('beforeEnter,to='+to+',from='+from+',next='+next)
                next()
                //next(to)    //此写法会进入死循环，不断进入beforeEnter方法
            }
        },
        {
            path: '/bar',
            name: 'getBar',
            alias: '/barAlias',
            component: Bar
        },
        {
            path: '/change',
            redirect: '/bar'
        },
        {
            path: '/',
            name: 'test',
            component: login.test
        }

    ]

    var router = new VueRouter({
        routes: routes
    });

    router.beforeEach( function(to, from, next) {
        //alert('beforeEach ,to='+to+',from='+from+',next='+next)
        next()
    })

    var app = new Vue({
        el:'#app',
        router:router
    })

    var breadcrumb = new Vue({
        el:'#layout-breadcrumb'
    })

</script>
</div>
</body>
</html>